# Weather Template Sensorer
- trigger:
    - platform: time_pattern
      minutes: "/15"
    - platform: homeassistant
      event: start
  action:
    - action: weather.get_forecasts
      target:
        entity_id: weather.forecast_hjem
      data:
        type: hourly
      response_variable: hourly
    - action: weather.get_forecasts
      target:
        entity_id: weather.forecast_hjem
      data:
        type: daily
      response_variable: daily
  sensor:
    - name: Vejrudsigt Hjemme
      unique_id: vejrudsigt_hjemme
      state: "{{ now().isoformat() }}"
      variables:
        current: >
          {% set fc = hourly['weather.forecast_hjem'].forecast %}
          {% set now_iso = now().isoformat() %}
          {# all forecasts at or before now #}
          {% set past = fc
               | selectattr('datetime', '<=', now_iso)
               | list %}
          {% if past | length > 0 %}
            {{ past[-1] }}
          {% else %}
            {{ fc[0] }}
          {% endif %}
      attributes:
        now_condition: >
          {% from 'weather_translate.jinja' import translate_condition %}
          {{ translate_condition(current.condition) }}
        now_icon: >
          {% set weather = current.condition %}
          {% if is_state('sun.sun', 'above_horizon') %}
            {{ '/local/weather/' + weather + '.svg' }}
          {% else %}
            {{ '/local/weather/' + weather + '_night.svg' }}
          {% endif %}
        now_temp: "{{ current.temperature }}"
        now_wind_speed: "{{ current.wind_speed }}"
        now_wind_gust_speed: "{{ current.wind_gust_speed }}"
        now_wind_bearing: "{{ current.wind_bearing }}"
        now_precipitation: "{{ current.precipitation }}"
        now_precipitation_probability: "{{ current.precipitation_probability }}"
        now_humidity: "{{ current.humidity }}"
        now_uv_index: "{{ current.uv_index }}"
        now_feels_like: >
          {% set T = (current.temperature | float) %}
          {% set K = (current.wind_speed | float) %}
          {% set V = (K / 1000 * 60 * 60) %}
          {% set A = 13.12 + 0.6215*T - 11.37*(V**0.16) + 0.3965*T*(V**0.16) %}
          {{ A | round(1) }}
        now_wind_direction: >
          {% set direction = ['N','NNØ','NØ','ØNØ','Ø','ØSØ','SØ','SSØ','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (current.wind_bearing | float) %}
          {{ direction[((degree + 11.25) / 22.5) | int] }}
        now_wind_description: >
          {% from 'weather_wind_speed.jinja' import get_wind_description %}
          {{ get_wind_description(current.wind_speed | float) }}
        today_condition: >
          {% from 'weather_translate.jinja' import translate_condition %}
          {{ translate_condition(daily['weather.forecast_hjem'].forecast[0].condition) }}
        today_icon: >
          {% set weather = daily['weather.forecast_hjem'].forecast[0].condition %}
          {{ '/local/weather/' + weather + '.svg' }}
        today_temp: "{{ daily['weather.forecast_hjem'].forecast[0].temperature }}"
        today_temp_low: "{{ daily['weather.forecast_hjem'].forecast[0].templow }}"
        today_wind_speed: "{{ daily['weather.forecast_hjem'].forecast[0].wind_speed }}"
        today_wind_gust_speed: "{{ daily['weather.forecast_hjem'].forecast[0].wind_gust_speed }}"
        today_wind_bearing: "{{ daily['weather.forecast_hjem'].forecast[0].wind_bearing }}"
        today_precipitation: "{{ daily['weather.forecast_hjem'].forecast[0].precipitation }}"
        today_precipitation_probability: "{{ daily['weather.forecast_hjem'].forecast[0].precipitation_probability }}"
        today_humidity: "{{ daily['weather.forecast_hjem'].forecast[0].humidity }}"
        today_uv_index: "{{ daily['weather.forecast_hjem'].forecast[0].uv_index }}"
        today_feels_like: >
          {% set T = (daily['weather.forecast_hjem'].forecast[0].temperature | float) %}
          {% set K = (daily['weather.forecast_hjem'].forecast[0].wind_speed | float) %}
          {% set V = (K/1000*60*60) %}
          {% set A = 13.12 + 0.6215*T - 11.37*(V**0.16) + 0.3965*T*(V**0.16) %}
          {{ (A) | round(1) }}
        today_wind_direction: >
          {% set direction = ['N','NNØ','NØ','ØNØ','Ø','ØSØ','SØ','SSØ','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (daily['weather.forecast_hjem'].forecast[0].wind_bearing | float) %}
          {{ direction[((degree+11.25)/22.5)|int] }}
        today_wind_description: >
          {% from 'weather_wind_speed.jinja' import get_wind_description %}
          {{ get_wind_description(daily['weather.forecast_hjem'].forecast[0].wind_speed | float) }}
        forecast1_datetime: "{{ daily['weather.forecast_hjem'].forecast[1].datetime }}"
        forecast1_condition: >
          {% from 'weather_translate.jinja' import translate_condition %}
          {{ translate_condition(daily['weather.forecast_hjem'].forecast[1].condition) }}
        forecast1_icon: >
          {% set weather = daily['weather.forecast_hjem'].forecast[1].condition %}
          {{ '/local/weather/' + weather + '.svg' }}
        forecast1_temp: "{{ daily['weather.forecast_hjem'].forecast[1].temperature }}"
        forecast1_temp_low: "{{ daily['weather.forecast_hjem'].forecast[1].templow }}"
        forecast1_wind_speed: "{{ daily['weather.forecast_hjem'].forecast[1].wind_speed }}"
        forecast1_wind_gust_speed: "{{ daily['weather.forecast_hjem'].forecast[1].wind_gust_speed }}"
        forecast1_wind_bearing: "{{ daily['weather.forecast_hjem'].forecast[1].wind_bearing }}"
        forecast1_precipitation: "{{ daily['weather.forecast_hjem'].forecast[1].precipitation }}"
        forecast1_precipitation_probability: "{{ daily['weather.forecast_hjem'].forecast[1].precipitation_probability }}"
        forecast1_humidity: "{{ daily['weather.forecast_hjem'].forecast[1].humidity }}"
        forecast1_uv_index: "{{ daily['weather.forecast_hjem'].forecast[1].uv_index }}"
        forecast1_feels_like: >
          {% set T = (daily['weather.forecast_hjem'].forecast[1].temperature | float) %}
          {% set K = (daily['weather.forecast_hjem'].forecast[1].wind_speed | float) %}
          {% set V = (K/1000*60*60) %}
          {% set A = 13.12 + 0.6215*T - 11.37*(V**0.16) + 0.3965*T*(V**0.16) %}
          {{ (A) | round(1) }}
        forecast1_wind_direction: >
          {% set direction = ['N','NNØ','NØ','ØNØ','Ø','ØSØ','SØ','SSØ','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (daily['weather.forecast_hjem'].forecast[1].wind_bearing | float) %}
          {{ direction[((degree+11.25)/22.5)|int] }}
        forecast1_wind_description: >
          {% from 'weather_wind_speed.jinja' import get_wind_description %}
          {{ get_wind_description(daily['weather.forecast_hjem'].forecast[1].wind_speed | float) }}
        forecast2_datetime: "{{ daily['weather.forecast_hjem'].forecast[2].datetime }}"
        forecast2_condition: >
          {% from 'weather_translate.jinja' import translate_condition %}
          {{ translate_condition(daily['weather.forecast_hjem'].forecast[2].condition) }}  
        forecast2_icon: >
          {% set weather = daily['weather.forecast_hjem'].forecast[2].condition %}
          {{ '/local/weather/' + weather + '.svg' }}
        forecast2_temp: "{{ daily['weather.forecast_hjem'].forecast[2].temperature }}"
        forecast2_temp_low: "{{ daily['weather.forecast_hjem'].forecast[2].templow }}"
        forecast2_wind_speed: "{{ daily['weather.forecast_hjem'].forecast[2].wind_speed }}"
        forecast2_wind_gust_speed: "{{ daily['weather.forecast_hjem'].forecast[2].wind_gust_speed }}"
        forecast2_wind_bearing: "{{ daily['weather.forecast_hjem'].forecast[2].wind_bearing }}"
        forecast2_precipitation: "{{ daily['weather.forecast_hjem'].forecast[2].precipitation }}"
        forecast2_precipitation_probability: "{{ daily['weather.forecast_hjem'].forecast[2].precipitation_probability }}"
        forecast2_humidity: "{{ daily['weather.forecast_hjem'].forecast[2].humidity }}"
        forecast2_uv_index: "{{ daily['weather.forecast_hjem'].forecast[2].uv_index }}"
        forecast2_feels_like: >
          {% set T = (daily['weather.forecast_hjem'].forecast[2].temperature | float) %}
          {% set K = (daily['weather.forecast_hjem'].forecast[2].wind_speed | float) %}
          {% set V = (K/1000*60*60) %}
          {% set A = 13.12 + 0.6215*T - 11.37*(V**0.16) + 0.3965*T*(V**0.16) %}
          {{ (A) | round(1) }}
        forecast2_wind_direction: >
          {% set direction = ['N','NNØ','NØ','ØNØ','Ø','ØSØ','SØ','SSØ','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (daily['weather.forecast_hjem'].forecast[2].wind_bearing | float) %}
          {{ direction[((degree+11.25)/22.5)|int] }}
        forecast2_wind_description: >
          {% from 'weather_wind_speed.jinja' import get_wind_description %}
          {{ get_wind_description(daily['weather.forecast_hjem'].forecast[2].wind_speed | float) }}
        forecast3_datetime: "{{ daily['weather.forecast_hjem'].forecast[3].datetime }}"
        forecast3_condition: >
          {% from 'weather_translate.jinja' import translate_condition %}
          {{ translate_condition(daily['weather.forecast_hjem'].forecast[3].condition) }}  
        forecast3_icon: >
          {% set weather = daily['weather.forecast_hjem'].forecast[3].condition %}
          {{ '/local/weather/' + weather + '.svg' }}
        forecast3_temp: "{{ daily['weather.forecast_hjem'].forecast[3].temperature }}"
        forecast3_temp_low: "{{ daily['weather.forecast_hjem'].forecast[3].templow }}"
        forecast3_wind_speed: "{{ daily['weather.forecast_hjem'].forecast[3].wind_speed }}"
        forecast3_wind_gust_speed: "{{ (daily['weather.forecast_hjem'].forecast[3] | default({}, true)).get('wind_gust_speed', '') }}"
        forecast3_wind_bearing: "{{ daily['weather.forecast_hjem'].forecast[3].wind_bearing }}"
        forecast3_precipitation: "{{ daily['weather.forecast_hjem'].forecast[3].precipitation }}"
        forecast3_precipitation_probability: "{{ daily['weather.forecast_hjem'].forecast[3].precipitation_probability }}"
        forecast3_humidity: "{{ daily['weather.forecast_hjem'].forecast[3].humidity }}"
        forecast3_uv_index: "{{ (daily['weather.forecast_hjem'].forecast[3] | default({}, true)).get('uv_index', '') }}"
        forecast3_feels_like: >
          {% set T = (daily['weather.forecast_hjem'].forecast[3].temperature | float) %}
          {% set K = (daily['weather.forecast_hjem'].forecast[3].wind_speed | float) %}
          {% set V = (K/1000*60*60) %}
          {% set A = 13.12 + 0.6215*T - 11.37*(V**0.16) + 0.3965*T*(V**0.16) %}
          {{ (A) | round(1) }}
        forecast3_wind_direction: >
          {% set direction = ['N','NNØ','NØ','ØNØ','Ø','ØSØ','SØ','SSØ','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (daily['weather.forecast_hjem'].forecast[3].wind_bearing | float) %}
          {{ direction[((degree+11.25)/22.5)|int] }}
        forecast3_wind_description: >
          {% from 'weather_wind_speed.jinja' import get_wind_description %}
          {{ get_wind_description(daily['weather.forecast_hjem'].forecast[3].wind_speed | float) }}
        forecast4_datetime: "{{ daily['weather.forecast_hjem'].forecast[4].datetime }}"
        forecast4_condition: >
          {% from 'weather_translate.jinja' import translate_condition %}
          {{ translate_condition(daily['weather.forecast_hjem'].forecast[4].condition) }}  
        forecast4_icon: >
          {% set weather = daily['weather.forecast_hjem'].forecast[4].condition %}
          {{ '/local/weather/' + weather + '.svg' }}
        forecast4_temp: "{{ daily['weather.forecast_hjem'].forecast[4].temperature }}"
        forecast4_temp_low: "{{ daily['weather.forecast_hjem'].forecast[4].templow }}"
        forecast4_wind_speed: "{{ daily['weather.forecast_hjem'].forecast[4].wind_speed }}"
        forecast4_wind_gust_speed: "{{ (daily['weather.forecast_hjem'].forecast[4] | default({}, true)).get('wind_gust_speed', '') }}"
        forecast4_wind_bearing: "{{ daily['weather.forecast_hjem'].forecast[4].wind_bearing }}"
        forecast4_precipitation: "{{ daily['weather.forecast_hjem'].forecast[4].precipitation }}"
        forecast4_precipitation_probability: "{{ daily['weather.forecast_hjem'].forecast[4].precipitation_probability }}"
        forecast4_humidity: "{{ daily['weather.forecast_hjem'].forecast[4].humidity }}"
        forecast4_uv_index: "{{ (daily['weather.forecast_hjem'].forecast[4] | default({}, true)).get('uv_index', '') }}"
        forecast4_feels_like: >
          {% set T = (daily['weather.forecast_hjem'].forecast[4].temperature | float) %}
          {% set K = (daily['weather.forecast_hjem'].forecast[4].wind_speed | float) %}
          {% set V = (K/1000*60*60) %}
          {% set A = 13.12 + 0.6215*T - 11.37*(V**0.16) + 0.3965*T*(V**0.16) %}
          {{ (A) | round(1) }}
        forecast4_wind_direction: >
          {% set direction = ['N','NNØ','NØ','ØNØ','Ø','ØSØ','SØ','SSØ','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (daily['weather.forecast_hjem'].forecast[4].wind_bearing | float) %}
          {{ direction[((degree+11.25)/22.5)|int] }}
        forecast4_wind_description: >
          {% from 'weather_wind_speed.jinja' import get_wind_description %}
          {{ get_wind_description(daily['weather.forecast_hjem'].forecast[4].wind_speed | float) }}
        forecast5_datetime: "{{ daily['weather.forecast_hjem'].forecast[5].datetime }}"
        forecast5_condition: >
          {% from 'weather_translate.jinja' import translate_condition %}
          {{ translate_condition(daily['weather.forecast_hjem'].forecast[5].condition) }}  
        forecast5_icon: >
          {% set weather = daily['weather.forecast_hjem'].forecast[5].condition %}
          {{ '/local/weather/' + weather + '.svg' }}
        forecast5_temp: "{{ daily['weather.forecast_hjem'].forecast[5].temperature }}"
        forecast5_temp_low: "{{ daily['weather.forecast_hjem'].forecast[5].templow }}"
        forecast5_wind_speed: "{{ daily['weather.forecast_hjem'].forecast[5].wind_speed }}"
        forecast5_wind_gust_speed: "{{ (daily['weather.forecast_hjem'].forecast[5] | default({}, true)).get('wind_gust_speed', '') }}"
        forecast5_wind_bearing: "{{ daily['weather.forecast_hjem'].forecast[5].wind_bearing }}"
        forecast5_precipitation: "{{ daily['weather.forecast_hjem'].forecast[5].precipitation }}"
        forecast5_precipitation_probability: "{{ daily['weather.forecast_hjem'].forecast[5].precipitation_probability }}"
        forecast5_humidity: "{{ daily['weather.forecast_hjem'].forecast[5].humidity }}"
        forecast5_uv_index: "{{ (daily['weather.forecast_hjem'].forecast[5] | default({}, true)).get('uv_index', '') }}"
        forecast5_feels_like: >
          {% set T = (daily['weather.forecast_hjem'].forecast[5].temperature | float) %}
          {% set K = (daily['weather.forecast_hjem'].forecast[5].wind_speed | float) %}
          {% set V = (K/1000*60*60) %}
          {% set A = 13.12 + 0.6215*T - 11.37*(V**0.16) + 0.3965*T*(V**0.16) %}
          {{ (A) | round(1) }}
        forecast5_wind_direction: >
          {% set direction = ['N','NNØ','NØ','ØNØ','Ø','ØSØ','SØ','SSØ','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (daily['weather.forecast_hjem'].forecast[5].wind_bearing | float) %}
          {{ direction[((degree+11.25)/22.5)|int] }}
        forecast5_wind_description: >
          {% from 'weather_wind_speed.jinja' import get_wind_description %}
          {{ get_wind_description(daily['weather.forecast_hjem'].forecast[5].wind_speed | float) }}
        hourly_forecast_times: >
          {% set hours = hourly['weather.forecast_hjem'].forecast[0:24] %}
          {{ hours | map(attribute='datetime') | list }}
        hourly_forecast_temperatures: >
          {% set hours = hourly['weather.forecast_hjem'].forecast[0:24] %}
          {{ hours | map(attribute='temperature') | list }}
